<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Neoweb</title>
    <style>
        @font-face {
            font-family: 'unscii-16';
            src: url('./unscii-16-full.woff') format('woff'), /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
                 url('./unscii-16-full.ttf') format('truetype'); /* Chrome 4+, Firefox 3.5, Opera 10+, Safari 3â€”5 */
        }
        .console {
            display: grid;
            container-type: inline-size;
            grid-template-columns: repeat(var(--cols), 1fr);
            grid-template-rows: repeat(var(--rows), 1fr);
            font-size: calc(200cqi / var(--cols));
            width: 100%;
            aspect-ratio: calc(var(--cols) / var(--rows) / 2);
            white-space: nowrap;
            background: black;
            color: lime;
            font-family: 'unscii-16';
            image-rendering: pixelated;
        }
        .cell {
            display: flex;
            overflow: visible;
            min-width: 0;
            min-height: 0;

            white-space: nowrap;
            line-height: 1;
        }
        body {
            margin: 0;
        }
    </style>
</head>
<body>
    <div id="container"></div>

    <script>
        let screens = [];

        function createScreen(element, cols, rows) {
            let child = document.createElement("div");
            child.classList.add("console");
            child.style = "--cols:" + cols + ";--rows:" + rows + ";"
            for (let i = 0; i < cols * rows; i++) {
                const cell = document.createElement("div");
                cell.classList.add("cell");
                child.appendChild(cell);
            }
            element.appendChild(child);
            screens.push({
                element: child,
                cols: cols,
                rows: rows,
            });
            return screens.length - 1;
        }

        function setCell(id, x, y, val) {
            const i = x + 80 * y;
            screens[id].element.children[i].innerText = val
        }
    </script>
    <script type="module">
        function wasmSetCell(id, x, y, val) {
            const t = String.fromCodePoint(val);
            setCell(id, x, y, t);
        }

        function tickComputer() {
            try {
                wasm.tick()
            } catch(e) {
                if (e instanceof WebAssembly.RuntimeError && e.message.includes("unreachable")) {
                    alert("panic: " + e.message);
                } else {
                    alert(e);
                }
            }
            requestAnimationFrame(tickComputer);
        }

        function runComputer() {
            try {
                wasm.init();
            } catch(e) {
                if (e instanceof WebAssembly.RuntimeError && e.message.includes("unreachable")) {
                    alert("panic: " + e.message);
                } else {
                    alert(e);
                }
            }
            requestAnimationFrame(tickComputer);
        }

        const importObject = {
            neoweb_console: {
                set_cell: wasmSetCell,
            },
            neoweb_utils: {
                get_time: () => {
                    Date.now() / 1000
                }
            },
        };
        let wasm = undefined;
        createScreen(document.getElementById("container"), 80, 25);

        const response = WebAssembly.instantiateStreaming(fetch("neoweb.wasm"), importObject).then(
            (obj) => {wasm = obj.instance.exports; runComputer()},
        );
    </script>
</body>
</html>